<!DOCTYPE html>
<html>
<head>
    <% include ./partials/head %>
        <link rel="stylesheet" type="text/css" href="css/chatroom.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>
        <script type="text/javascript">
            var socket = io()
            var nickname

            $(function () {

                $('form#message-form').on('submit', function (e) {
                    e.preventDefault()
                    var m = $('input#m')
                    socket.emit('fromClient', 
                    {
                        nickname:nickname,
                        message:m.val()
                    })
                    m.val('')
                    m.focus()
                })
                // message from myself
                socket.on('toClient toMyself', function (data) {
                    $('div#message-list')
                        .append($('<div class="my-message-box"></div>')
                        .append($('<span>time</span>'))
                        .append($('<span class="my-message"></span>').text(data.message)))
                        .animate({
                         scrollTop: $('div#message-list').get(0).scrollHeight
                    }, 500)
                })
                // message from friends
                socket.on('toClient toFriends', function (data) {
                    $('div#message-list')
                        .append($('<div class="friends-message-box"></div>')
                        .append($('<p class="friends-name"></p>').text(data.nickname))
                        .append($('<span class="friends-message"></span>').text(data.message))
                        .append($('<span>time</span>')))
                        .animate({
                         scrollTop: $('div#message-list').get(0).scrollHeight
                    }, 500)
                })
                // add  new comer's nickname to the friends list
                socket.on('freindsList', function(data) {
                    var mySocketIdIndex = data.id.indexOf(socket.id)
                    nickname = data.nickname[mySocketIdIndex];
                    console.log(nickname)
                    $('ul#friend-list').empty()
                    data.nickname.forEach(function(nickname, index) {
                        if(index===mySocketIdIndex)
                            $('ul#friend-list').append($('<li></li>').text(nickname+"(me)")
                                .css('font-weight', 'bold'))
                        else
                             $('ul#friend-list').append($('<li></li>').text(nickname))                           
                    })
                })
            })
        </script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-sm-8 col-xs-12">
                <h2>Room Name</h2>
                <div id="message-list" class="scroll-list"></ul>
                </div>
                <form id="message-form">
                    <div class="input-group">
                        <input id="m" class="form-control" type="text">
                        <div class="input-group-btn">
                            <button type="submit" class="btn btn-info">Send</button>
                        </div>
                    </div>
                </form>
            </div><!--div.col-->
            <div class="col-sm-4 col-xs-12">
                <h2>Friends List</h2>
                <ul id="friend-list" class="scroll-list"></ul>
            </div>
        </div><!--div.row-->
    </div><!--div.container-->

</body>
</html>